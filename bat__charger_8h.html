<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Libre Solar Charge Controller Firmware: src/bat_charger.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Libre Solar Charge Controller Firmware
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('bat__charger_8h.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#enum-members">Enumerations</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">bat_charger.h File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Battery and charger configuration and functions.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;stdint.h&gt;</code><br />
<code>#include &lt;stdbool.h&gt;</code><br />
<code>#include &lt;stddef.h&gt;</code><br />
<code>#include &lt;time.h&gt;</code><br />
<code>#include &quot;<a class="el" href="power__port_8h_source.html">power_port.h</a>&quot;</code><br />
</div>
<p><a href="bat__charger_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structBatConf.html">BatConf</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">class &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classCharger.html">Charger</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="enum-members"></a>
Enumerations</h2></td></tr>
<tr class="memitem:aa11cdbd2b05183d3bc59f70fbce02ab1"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bat__charger_8h.html#aa11cdbd2b05183d3bc59f70fbce02ab1">BatType</a> { <br />
&#160;&#160;<a class="el" href="bat__charger_8h.html#aa11cdbd2b05183d3bc59f70fbce02ab1aa037fc1e16a5c7834578e49740bb73e3">BAT_TYPE_CUSTOM</a> = 0, 
<a class="el" href="bat__charger_8h.html#aa11cdbd2b05183d3bc59f70fbce02ab1aa5dcc2b6fc7a492f831d3f69e2d07547">BAT_TYPE_FLOODED</a>, 
<a class="el" href="bat__charger_8h.html#aa11cdbd2b05183d3bc59f70fbce02ab1ac5bdfe5e7c221845aaebeef0f9ca8587">BAT_TYPE_GEL</a>, 
<a class="el" href="bat__charger_8h.html#aa11cdbd2b05183d3bc59f70fbce02ab1a232968d1d678438ca2d0b124ef53b9d1">BAT_TYPE_AGM</a>, 
<br />
&#160;&#160;<a class="el" href="bat__charger_8h.html#aa11cdbd2b05183d3bc59f70fbce02ab1a59ef023dfa7a40c9573ed509dee98764">BAT_TYPE_LFP</a>, 
<a class="el" href="bat__charger_8h.html#aa11cdbd2b05183d3bc59f70fbce02ab1a48c5dd07956d5872ab0f64ca3f5e21be">BAT_TYPE_NMC</a>, 
<a class="el" href="bat__charger_8h.html#aa11cdbd2b05183d3bc59f70fbce02ab1af31cd12c54b120aeef9e7084ca17938b">BAT_TYPE_NMC_HV</a>
<br />
 }</td></tr>
<tr class="separator:aa11cdbd2b05183d3bc59f70fbce02ab1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af912b18af8de205312a5d27282e95cde"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bat__charger_8h.html#af912b18af8de205312a5d27282e95cde">ChargerState</a> { <br />
&#160;&#160;<a class="el" href="bat__charger_8h.html#af912b18af8de205312a5d27282e95cdea8c366c835b7b61c99f62e35daaf22ccb">CHG_STATE_IDLE</a>, 
<a class="el" href="bat__charger_8h.html#af912b18af8de205312a5d27282e95cdeaf2b452aac8ca8fead354ef63b4c41e64">CHG_STATE_BULK</a>, 
<a class="el" href="bat__charger_8h.html#af912b18af8de205312a5d27282e95cdea946d47ceea42e16daac32c702a57e6d4">CHG_STATE_TOPPING</a>, 
<a class="el" href="bat__charger_8h.html#af912b18af8de205312a5d27282e95cdea5f3ba2136bd779f0ca4f354c651be64c">CHG_STATE_TRICKLE</a>, 
<br />
&#160;&#160;<a class="el" href="bat__charger_8h.html#af912b18af8de205312a5d27282e95cdea728dcb69a9abdbd212584fe48ddefbb7">CHG_STATE_EQUALIZATION</a>
<br />
 }</td></tr>
<tr class="separator:af912b18af8de205312a5d27282e95cde"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a44bdb94a395090ca514b770155933259"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bat__charger_8h.html#a44bdb94a395090ca514b770155933259">battery_conf_init</a> (<a class="el" href="structBatConf.html">BatConf</a> *bat, int type, int num_cells, float nominal_capacity)</td></tr>
<tr class="separator:a44bdb94a395090ca514b770155933259"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af846fb31026546eecf860d415b9e2381"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bat__charger_8h.html#af846fb31026546eecf860d415b9e2381">battery_conf_check</a> (<a class="el" href="structBatConf.html">BatConf</a> *bat)</td></tr>
<tr class="separator:af846fb31026546eecf860d415b9e2381"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8741ee6b335f369491a00576be951f82"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bat__charger_8h.html#a8741ee6b335f369491a00576be951f82">battery_conf_overwrite</a> (<a class="el" href="structBatConf.html">BatConf</a> *source, <a class="el" href="structBatConf.html">BatConf</a> *destination, <a class="el" href="classCharger.html">Charger</a> *charger=NULL)</td></tr>
<tr class="separator:a8741ee6b335f369491a00576be951f82"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0fcd3e360cf3b348c08ce5b95f270bb7"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="bat__charger_8h.html#a0fcd3e360cf3b348c08ce5b95f270bb7">battery_conf_changed</a> (<a class="el" href="structBatConf.html">BatConf</a> *a, <a class="el" href="structBatConf.html">BatConf</a> *b)</td></tr>
<tr class="separator:a0fcd3e360cf3b348c08ce5b95f270bb7"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Battery and charger configuration and functions. </p>
</div><h2 class="groupheader">Enumeration Type Documentation</h2>
<a class="anchor" id="aa11cdbd2b05183d3bc59f70fbce02ab1"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="bat__charger_8h.html#aa11cdbd2b05183d3bc59f70fbce02ab1">BatType</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Battery cell types </p>
<table class="fieldtable">
<tr><th colspan="2">Enumerator</th></tr><tr><td class="fieldname"><a class="anchor" id="aa11cdbd2b05183d3bc59f70fbce02ab1aa037fc1e16a5c7834578e49740bb73e3"></a>BAT_TYPE_CUSTOM&#160;</td><td class="fielddoc">
<p>Custom battery type. </p>
</td></tr>
<tr><td class="fieldname"><a class="anchor" id="aa11cdbd2b05183d3bc59f70fbce02ab1aa5dcc2b6fc7a492f831d3f69e2d07547"></a>BAT_TYPE_FLOODED&#160;</td><td class="fielddoc">
<p>Old flooded (wet) lead-acid batteries. </p>
</td></tr>
<tr><td class="fieldname"><a class="anchor" id="aa11cdbd2b05183d3bc59f70fbce02ab1ac5bdfe5e7c221845aaebeef0f9ca8587"></a>BAT_TYPE_GEL&#160;</td><td class="fielddoc">
<p>VRLA gel batteries (maintainance-free) </p>
</td></tr>
<tr><td class="fieldname"><a class="anchor" id="aa11cdbd2b05183d3bc59f70fbce02ab1a232968d1d678438ca2d0b124ef53b9d1"></a>BAT_TYPE_AGM&#160;</td><td class="fielddoc">
<p>AGM batteries (maintainance-free) </p>
</td></tr>
<tr><td class="fieldname"><a class="anchor" id="aa11cdbd2b05183d3bc59f70fbce02ab1a59ef023dfa7a40c9573ed509dee98764"></a>BAT_TYPE_LFP&#160;</td><td class="fielddoc">
<p>LiFePO4 Li-ion batteries (3.3V nominal) </p>
</td></tr>
<tr><td class="fieldname"><a class="anchor" id="aa11cdbd2b05183d3bc59f70fbce02ab1a48c5dd07956d5872ab0f64ca3f5e21be"></a>BAT_TYPE_NMC&#160;</td><td class="fielddoc">
<p>NMC/Graphite Li-ion batteries (3.7V nominal) </p>
</td></tr>
<tr><td class="fieldname"><a class="anchor" id="aa11cdbd2b05183d3bc59f70fbce02ab1af31cd12c54b120aeef9e7084ca17938b"></a>BAT_TYPE_NMC_HV&#160;</td><td class="fielddoc">
<p>NMC/Graphite High Voltage Li-ion batteries (3.7V nominal, 4.35 max) </p>
</td></tr>
</table>

</div>
</div>
<a class="anchor" id="af912b18af8de205312a5d27282e95cde"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="bat__charger_8h.html#af912b18af8de205312a5d27282e95cde">ChargerState</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Possible charger states</p>
<p>Further information:</p><ul>
<li><a href="https://en.wikipedia.org/wiki/IUoU_battery_charging">https://en.wikipedia.org/wiki/IUoU_battery_charging</a></li>
<li><a href="https://batteryuniversity.com/learn/article/charging_the_lead_acid_battery">https://batteryuniversity.com/learn/article/charging_the_lead_acid_battery</a> </li>
</ul>
<table class="fieldtable">
<tr><th colspan="2">Enumerator</th></tr><tr><td class="fieldname"><a class="anchor" id="af912b18af8de205312a5d27282e95cdea8c366c835b7b61c99f62e35daaf22ccb"></a>CHG_STATE_IDLE&#160;</td><td class="fielddoc">
<p>Idle</p>
<p>Initial state of the charge controller. If the solar voltage is high enough and the battery is not full, bulk charging mode is started. </p>
</td></tr>
<tr><td class="fieldname"><a class="anchor" id="af912b18af8de205312a5d27282e95cdeaf2b452aac8ca8fead354ef63b4c41e64"></a>CHG_STATE_BULK&#160;</td><td class="fielddoc">
<p>Bulk / CC / MPPT charging</p>
<p>The battery is charged with maximum possible current (MPPT algorithm is active) until the CV voltage limit is reached. </p>
</td></tr>
<tr><td class="fieldname"><a class="anchor" id="af912b18af8de205312a5d27282e95cdea946d47ceea42e16daac32c702a57e6d4"></a>CHG_STATE_TOPPING&#160;</td><td class="fielddoc">
<p>Topping / CV / absorption charging</p>
<p>Lead-acid batteries are charged for some time using a slightly higher charge voltage. After a current cutoff limit or a time limit is reached, the charger goes into trickle or equalization mode for lead-acid batteries or back into Standby for Li-ion batteries. </p>
</td></tr>
<tr><td class="fieldname"><a class="anchor" id="af912b18af8de205312a5d27282e95cdea5f3ba2136bd779f0ca4f354c651be64c"></a>CHG_STATE_TRICKLE&#160;</td><td class="fielddoc">
<p>Trickle charging</p>
<p>This mode is kept forever for a lead-acid battery and keeps the battery at full state of charge. If too much power is drawn from the battery, the charger switches back into CC / bulk charging mode. </p>
</td></tr>
<tr><td class="fieldname"><a class="anchor" id="af912b18af8de205312a5d27282e95cdea728dcb69a9abdbd212584fe48ddefbb7"></a>CHG_STATE_EQUALIZATION&#160;</td><td class="fielddoc">
<p>Equalization charging</p>
<p>This mode is only used for lead-acid batteries after several deep-discharge cycles or a very long period of time with no equalization. Voltage is increased to 15V or above, so care must be taken for the other system components attached to the battery. (currently, no equalization charging is enabled in the software) </p>
</td></tr>
</table>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a0fcd3e360cf3b348c08ce5b95f270bb7"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool battery_conf_changed </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structBatConf.html">BatConf</a> *&#160;</td>
          <td class="paramname"><em>a</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structBatConf.html">BatConf</a> *&#160;</td>
          <td class="paramname"><em>b</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Checks if incoming configuration is different to current configuration</p>
<p>Returns true if changed </p>

</div>
</div>
<a class="anchor" id="af846fb31026546eecf860d415b9e2381"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool battery_conf_check </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structBatConf.html">BatConf</a> *&#160;</td>
          <td class="paramname"><em>bat</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Checks battery user settings for plausibility </p>

</div>
</div>
<a class="anchor" id="a44bdb94a395090ca514b770155933259"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void battery_conf_init </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structBatConf.html">BatConf</a> *&#160;</td>
          <td class="paramname"><em>bat</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>num_cells</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">float&#160;</td>
          <td class="paramname"><em>nominal_capacity</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Basic initialization of battery configuration</p>
<p>Configures battery based on settings defined in config.h and initializes bat_user with same values</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">bat</td><td>Battery configuration that should be initialized </td></tr>
    <tr><td class="paramname">type</td><td>Battery type, one of enum BatType (declared as int instead of enum BatType because configuration via Kconfig symbol cannot handle enums) </td></tr>
    <tr><td class="paramname">num_cells</td><td>Number of cells (e.g. 6 for 12V lead-acid battery) </td></tr>
    <tr><td class="paramname">nominal_capacity</td><td>Nominal capacity (Ah) </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="a8741ee6b335f369491a00576be951f82"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void battery_conf_overwrite </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structBatConf.html">BatConf</a> *&#160;</td>
          <td class="paramname"><em>source</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structBatConf.html">BatConf</a> *&#160;</td>
          <td class="paramname"><em>destination</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classCharger.html">Charger</a> *&#160;</td>
          <td class="paramname"><em>charger</em> = <code>NULL</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Overwrites battery settings (config should be checked first)</p>
<p>Settings specified in bat_user will be copied to actual battery_t, if suggested updates are valid (includes plausibility check!) </p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="bat__charger_8h.html">bat_charger.h</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
